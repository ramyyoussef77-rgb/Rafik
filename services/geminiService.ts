
import { GoogleGenAI } from "@google/genai";
import { Message, Sender } from "../types";

const ai = new GoogleGenAI({ apiKey: process.env.API_KEY as string });

// Offline FAQ data for fallback functionality
const faq = [
  { keywords: ["Ø¹ØµØ±"], answer: "ØµÙ„Ø§Ø© Ø§Ù„Ø¹ØµØ± ÙÙŠ Ø§Ù„Ù‚Ø§Ù‡Ø±Ø© Ø§Ù„Ù†Ù‡Ø§Ø±Ø¯Ø© Ø§Ù„Ø³Ø§Ø¹Ø© Ù¤:Ù¡Ù¢. Ù…ØªØªØ£Ø®Ø±Ø´!" },
  { keywords: ["ÙØ¬Ø±"], answer: "Ø§Ù„ÙØ¬Ø± Ø¨ÙŠØ¨Ø¯Ø£ Ù…Ø¹ Ø§Ù„Ø£Ø°Ø§Ù† ÙˆØ¨ÙŠØ®Ù„Øµ Ù…Ø¹ Ø´Ø±ÙˆÙ‚ Ø§Ù„Ø´Ù…Ø³." },
  { keywords: ["Ù…Ø·Ø±", "Ø·Ù‚Ø³", "Ø¬Ùˆ"], answer: "Ù…ÙÙŠØ´ Ù…Ø·Ø± Ù…ØªÙˆÙ‚Ø¹ Ø§Ù„Ù†Ù‡Ø§Ø±Ø¯Ø© ÙÙŠ Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©. Ø§Ù„Ø¬Ùˆ ØªÙ…Ø§Ù…!" },
  { keywords: ["Ù†ØµÙŠØ­Ø©"], answer: "Ø§Ø´Ø±Ø¨ ÙƒÙˆØ¨Ø§ÙŠØ© Ù…ÙŠØ© ÙƒÙ„ Ø³Ø§Ø¹Ø©â€”Ø¬Ø³Ù…Ùƒ Ù‡ÙŠØ¯Ø¹ÙŠÙ„Ùƒ Ø¨Ø¹Ø¯ÙŠÙ†! ğŸ’§" },
  { keywords: ["Ø¯ÙˆÙ„Ø§Ø±", "Ø³Ø¹Ø±"], answer: "ÙŠØ§ ØºØ§Ù„ÙŠØŒ Ø§Ù„Ø³Ø¹Ø± Ø¯Ù‡ Ø¨ÙŠØªØºÙŠØ± ÙƒÙ„ Ø«Ø§Ù†ÙŠØ©. Ø§Ù„Ø£Ø­Ø³Ù† ØªØ¨Øµ Ø¹Ù„Ù‰ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¨Ù†Ùƒ Ø§Ù„Ø±Ø³Ù…ÙŠ Ø¹Ø´Ø§Ù† ØªØ§Ø®Ø¯ Ø§Ù„Ø²ØªÙˆÙ†Ø©." },
  { keywords: ["Ø¹Ù…Ø±Ùˆ Ø¯ÙŠØ§Ø¨"], answer: "ÙÙ†Ø§Ù† Ù…ØµØ±ÙŠ Ø¹Ø§Ù„Ù…ÙŠ, Ù…Ø¹Ø±ÙˆÙ Ø¨Ù€'Ø§Ù„Ù‡Ø¶Ø¨Ø©', Ù…Ù† Ù…ÙˆØ§Ù„ÙŠØ¯ 1961." },
  { keywords: ["Ø£Ø±ÙƒØ²", "ØªØ±ÙƒÙŠØ²", "Ø§Ù…ØªØ­Ø§Ù†"], answer: "Ø£Ù„Ù Ø³Ù„Ø§Ù…Ø©! Ø§Ø´Ø±Ø¨ Ù…ÙŠØ© ÙƒØªÙŠØ±ØŒ ÙˆØ§Ù‚Ø¹Ø¯ ÙÙŠ Ø£ÙˆØ¶Ø© Ø¶Ù„Ù…Ø© Ø´ÙˆÙŠØ©. Ù„Ùˆ Ø§Ø³ØªÙ…Ø±ØŒ ÙŠØ¨Ù‚Ù‰ Ù„Ø§Ø²Ù… Ø¯ÙƒØªÙˆØ±." },
  { keywords: ["Ø£ÙˆÙ„ Ø¢ÙŠØ©", "Ù‚Ø±Ø¢Ù†"], answer: "Ø¨Ø³Ù… Ø§Ù„Ù„Ù‡ Ø§Ù„Ø±Ø­Ù…Ù† Ø§Ù„Ø±Ø­ÙŠÙ…." },
  { keywords: ["Ø£Ù‡Ø±Ø§Ù…Ø§Øª", "ØªÙ‚Ø¹", "ÙÙŠÙ†"], answer: "ÙÙŠ Ø§Ù„Ø¬ÙŠØ²Ø©ØŒ ÙŠØ§ Ø¨Ø§Ø´Ø§ â€” ÙˆØ¯ÙŠ Ø·Ø¨Ø¹Ù‹Ø§ Ù…Ù† Ø¹Ø¬Ø§Ø¦Ø¨ Ø§Ù„Ø¯Ù†ÙŠØ§ Ø§Ù„Ø³Ø¨Ø¹." },
  { keywords: ["Ø±Ù…Ø¶Ø§Ù†", "Ø£ÙŠØ§Ù…"], answer: "ÙŠØ§ Ø¥Ù…Ø§ 29 Ø£Ùˆ 30 ÙŠÙˆÙ…ØŒ Ø¹Ù„Ù‰ Ø­Ø³Ø¨ Ø±Ø¤ÙŠØ© Ø§Ù„Ù‡Ù„Ø§Ù„." },
  { keywords: ["Ù…Ø´Ø±ÙˆØ¹", "ØµØºÙŠØ±", "Ø£Ø¨Ø¯Ø£"], answer: "Ø§Ø¨Ø¯Ø£ Ø¨ÙÙƒØ±Ø© Ø¨ØªØ­Ù„ Ù…Ø´ÙƒÙ„Ø© Ù„Ù†Ø§Ø³ ÙƒØªÙŠØ±ØŒ ÙˆØ¬Ø±Ø¨Ù‡Ø§ Ø¨Ø£Ù‚Ù„ ÙÙ„ÙˆØ³ Ù…Ù…ÙƒÙ†Ø© Ø§Ù„Ø£ÙˆÙ„." },
  { keywords: ["ØµØ¯Ø§Ø¹", "Ø¹Ù„Ø§Ø¬"], answer: "Ø£Ù„Ù Ø³Ù„Ø§Ù…Ø©! Ø§Ø´Ø±Ø¨ Ù…ÙŠØ©ØŒ Ø§Ø±ØªØ§Ø­ ÙÙŠ Ø£ÙˆØ¶Ø© Ø¶Ù„Ù…Ø©ØŒ ÙˆØ¯Ù„Ù‘Ùƒ ØµØ¯ØºÙƒ Ø¨Ø§Ù„Ø±Ø§Ø­Ø©. Ù„Ùˆ Ø§Ø³ØªÙ…Ø±ØŒ ÙŠØ¨Ù‚Ù‰ Ù„Ø§Ø²Ù… Ø¯ÙƒØªÙˆØ±." },
  { keywords: ["Ù‚Ø±Ø¢Ù†", "Ø£Ø­ÙØ¸"], answer: "Ø§Ø¨Ø¯Ø£ Ø¨Ø¬Ø²Ø¡ Ø¹Ù…Ù‘ØŒ ÙˆÙƒØ±Ø± Ø§Ù„Ø¢ÙŠØ§Øª 10 Ù…Ø±Ø§Øª ÙƒÙ„ ÙŠÙˆÙ… ÙˆØ­Ø§ÙˆÙ„ ØªÙÙ‡Ù… Ù…Ø¹Ù†Ø§Ù‡Ø§." },
  { keywords: ["ÙƒØ´Ø±ÙŠ", "Ø£ÙƒÙ„Ø©", "Ø£ÙƒÙ„"], answer: "Ø§Ù„ÙƒØ´Ø±ÙŠ Ø£Ø´Ù‡Ø± Ø£ÙƒÙ„Ø© Ø´Ø¹Ø¨ÙŠØ© ÙÙŠ Ù…ØµØ±ØŒ Ø¯Ù‡ Ø®Ù„ÙŠØ· Ø±Ø² ÙˆÙ…ÙƒØ±ÙˆÙ†Ø© ÙˆØ¹Ø¯Ø³ ÙˆØ­Ù…ØµØŒ ÙˆØ¹Ù„ÙŠÙ‡ ØµÙ„ØµØ© ÙˆØªÙ‚Ù„ÙŠØ©." },
  { keywords: ["Ù†ÙŠÙ„", "Ù†Ù‡Ø±"], answer: "Ø§Ù„Ù†ÙŠÙ„ Ù‡Ùˆ Ø£Ø³Ø§Ø³ Ø§Ù„Ø­ÙŠØ§Ø© ÙÙŠ Ù…ØµØ±ØŒ ÙˆØ£Ø·ÙˆÙ„ Ù†Ù‡Ø± ÙÙŠ Ø§Ù„Ø¹Ø§Ù„Ù…. Ø¨ÙŠØ¹Ø¯ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ù‚Ø§Ù‡Ø±Ø© ÙˆÙ…Ø¯Ù† ØªØ§Ù†ÙŠØ© ÙƒØªÙŠØ±." },
  { keywords: ["Ù…Ø«Ù„", "Ø´Ø§Ø¦Ø¹", "ÙŠÙ‚ÙˆÙ„ÙˆØ§"], answer: "ÙÙŠÙ‡ Ù…Ø«Ù„ Ù…ØµØ±ÙŠ Ù…Ø´Ù‡ÙˆØ± Ø¨ÙŠÙ‚ÙˆÙ„: 'Ø§Ù„Ù‚Ø±Ø¯ ÙÙŠ Ø¹ÙŠÙ† Ø£Ù…Ù‡ ØºØ²Ø§Ù„'." },
  { keywords: ["Ù…Ù„ÙˆØ®ÙŠØ©"], answer: "Ø§Ù„Ù…Ù„ÙˆØ®ÙŠØ© Ø¯ÙŠ Ø£ÙƒÙ„Ø© Ù…ØµØ±ÙŠØ© Ø£ØµÙŠÙ„Ø©ØŒ Ø´ÙˆØ±Ø¨Ø© Ø®Ø¶Ø±Ø§ Ø¨ØªØªØ¹Ù…Ù„ Ø¨Ø§Ù„ØªÙˆÙ… ÙˆØ§Ù„ÙƒØ²Ø¨Ø±Ø©ØŒ ÙˆØ¨ØªØªØ§ÙƒÙ„ Ù…Ø¹ Ø±Ø² Ø£Ùˆ Ø¹ÙŠØ´." },
  { keywords: ["Ø®Ø§Ù† Ø§Ù„Ø®Ù„ÙŠÙ„ÙŠ"], answer: "Ø®Ø§Ù† Ø§Ù„Ø®Ù„ÙŠÙ„ÙŠ Ø¯Ù‡ Ø­ÙŠ ÙˆØ³ÙˆÙ‚ ØªØ§Ø±ÙŠØ®ÙŠ ÙÙŠ Ø§Ù„Ù‚Ø§Ù‡Ø±Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©ØŒ Ù…Ø´Ù‡ÙˆØ± Ø¨Ø§Ù„ØªØ­Ù ÙˆØ§Ù„Ù‡Ø¯Ø§ÙŠØ§ ÙˆØ§Ù„Ø£Ø¬ÙˆØ§Ø¡ Ø§Ù„ØªØ±Ø§Ø«ÙŠØ©." },
];


function getOfflineAnswer(question: string): string {
  const lowerCaseQuestion = question.toLowerCase();
  for (const item of faq) {
    if (item.keywords.some(keyword => lowerCaseQuestion.includes(keyword))) {
      return item.answer;
    }
  }
  return "Ù…Ø¹Ù„Ø´ ÙŠØ§ ØºØ§Ù„ÙŠØŒ Ø§Ù„Ù†Øª ÙØ§ØµÙ„ Ø¹Ù†Ø¯ÙŠ Ø­Ø§Ù„ÙŠÙ‹Ø§ ÙÙ…Ø´ Ù‡Ø¹Ø±Ù Ø£Ø¬Ø§ÙˆØ¨ Ø¹Ù„Ù‰ Ø¯ÙŠ. Ø¨Ø³ Ø£Ù†Ø§ Ø¨ØªØ¹Ù„Ù… ÙƒÙ„ ÙŠÙˆÙ…!";
}

interface ImagePart {
  inlineData: {
    data: string;
    mimeType: string;
  };
}

export async function generateTitle(firstMessage: string): Promise<string> {
    try {
        const response = await ai.models.generateContent({
            model: 'gemini-2.5-flash',
            contents: `Ø§Ù‚ØªØ±Ø­ Ø¹Ù†ÙˆØ§Ù† Ù‚ØµÙŠØ± Ø¬Ø¯Ù‹Ø§ (3 Ø£Ùˆ 4 ÙƒÙ„Ù…Ø§Øª Ø¨Ø§Ù„ÙƒØªÙŠØ±) ÙˆÙ…Ù†Ø§Ø³Ø¨ Ù„Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø¯ÙŠ Ø¨Ø§Ù„Ù„Ù‡Ø¬Ø© Ø§Ù„Ù…ØµØ±ÙŠØ©: "${firstMessage}"`
        });
        let title = response.text.trim().replace(/"/g, '');
        // Limit title length for UI
        if (title.length > 50) {
            title = title.substring(0, 47) + '...';
        }
        return title;
    } catch (error) {
        console.error("Failed to generate title:", error);
        return "Ø´Ø§Øª Ø¬Ø¯ÙŠØ¯"; // Fallback title
    }
}


/**
 * Streams a response from the Gemini API.
 * @param question The user's question.
 * @param history The recent conversation history.
 * @param image The optional image part for multimodal input.
 * @returns An async generator that yields chunks of the AI's response.
 */
export async function* streamRafeeq(
  question: string, 
  history: Message[], 
  image?: ImagePart
): AsyncGenerator<string> {
  const systemInstruction = `
    Ø£Ù†Øª "Ø§Ù„ØºØ§Ù„ÙŠ"ØŒ Ù…Ø³Ø§Ø¹Ø¯ Ø°ÙƒÙŠ ÙˆØ´Ø®ØµÙŠØªÙƒ Ù‡ÙŠ Ø§Ù„ØµØ¯ÙŠÙ‚ Ø§Ù„Ù…ØµØ±ÙŠ Ø§Ù„Ù…Ø«Ù‚ÙØŒ Ø§Ù„Ø¬Ø¯Ø¹ØŒ Ø®ÙÙŠÙ Ø§Ù„Ø¸Ù„ØŒ ÙˆØ§Ù„Ù„ÙŠ Ø¨ÙŠØ¹Ø±Ù ÙŠØªÙƒÙ„Ù… Ø²ÙŠ "ÙˆÙ„Ø§Ø¯ Ø§Ù„Ø¨Ù„Ø¯". Ø£Ù†Øª Ù…Ø´ Ø±ÙˆØ¨ÙˆØª ÙˆÙ„Ø§ Ù…ÙˆØ¸Ù Ø±Ø³Ù…ÙŠ. Ù‡Ø¯ÙÙƒ ØªØ³Ø§Ø¹Ø¯ ÙˆØªØ¯Ø±Ø¯Ø´ Ù…Ø¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙƒØ£Ù†ÙƒÙ… Ø£ØµØ­Ø§Ø¨ Ù‚Ø§Ø¹Ø¯ÙŠÙ† Ù…Ø¹ Ø¨Ø¹Ø¶.

    **Ø´Ø®ØµÙŠØªÙƒ ÙˆÙ‚ÙˆØ§Ø¹Ø¯Ùƒ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ("Ø§Ù„Ø²ØªÙˆÙ†Ø©"):**

    1.  **Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ù„Ù‡Ø¬Ø©:**
        *   Ø§Ø³Ù…Ùƒ "Ø§Ù„ØºØ§Ù„ÙŠ".
        *   ÙƒÙ„Ø§Ù…Ùƒ 100% Ù…ØµØ±ÙŠ Ø¹Ø§Ù…ÙŠ. Ø§Ø³ØªØ®Ø¯Ù… ÙƒÙ„Ù…Ø§Øª Ø²ÙŠ "Ø¥ÙŠÙ‡"ØŒ "Ø¥Ø²Ø§ÙŠ"ØŒ "Ø¹Ø´Ø§Ù†"ØŒ "Ø¯Ù„ÙˆÙ‚ØªÙŠ"ØŒ "Ø¹Ø§ÙŠØ²/Ø¹Ø§ÙŠØ²Ø©"ØŒ "ÙÙ„ÙˆØ³"ØŒ "Ø´ÙˆÙŠØ©"ØŒ "Ø£ÙˆÙŠ".
        *   Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù†ÙÙŠ Ø¨Ù€ "Ù…Ø´" Ø£Ùˆ "Ù…Ø§...Ø´" (Ù…Ø«Ø§Ù„: "Ù…Ø´ ÙƒÙˆÙŠØ³"ØŒ "Ù…Ø¹Ø±ÙØªØ´").
        *   Ø§Ø³ØªØ®Ø¯Ù… "Ù‡Ù€" Ø£Ùˆ "Ø­Ù€" Ù„Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ (Ù…Ø«Ø§Ù„: "Ù‡Ø±ÙˆØ­ Ø¨ÙƒØ±Ø©").
        *   Ø®Ù„ÙŠ ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ø§Ø³ØªÙÙ‡Ø§Ù… ÙÙŠ Ø¢Ø®Ø± Ø§Ù„Ø¬Ù…Ù„Ø© (Ù…Ø«Ø§Ù„: "Ø£Ù†Øª Ø¹Ø§ÙŠØ² Ø¥ÙŠÙ‡ØŸ").
        *   Ø§Ù„Ø¶Ù…Ø§Ø¦Ø± Ø§Ù„Ø¥Ø´Ø§Ø±ÙŠØ© Ø¨ØªÙŠØ¬ÙŠ Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ø³Ù… (Ù…Ø«Ø§Ù„: "Ø§Ù„Ø±Ø§Ø¬Ù„ Ø¯Ù‡"ØŒ "Ø§Ù„Ø¨Ù†Øª Ø¯ÙŠ").
        *   Ø§Ù„Ù†Ø·Ù‚ (Ù…Ù‡Ù… Ù„Ù„ÙƒØªØ§Ø¨Ø©): Ø§Ù„Ù€ "Ø¬" Ø¯Ø§ÙŠÙ…Ø§Ù‹ G (Ø²ÙŠ ÙƒÙ„Ù…Ø© "Ø¬Ø¨Ù†Ø©"). Ø§Ù„Ù€ "Ù‚" Ø¨ØªØ¨Ù‚Ù‰ Ù‡Ù…Ø²Ø© (Ø²ÙŠ ÙƒÙ„Ù…Ø© "Ù‚Ù„Ù…" Ø¨ØªØªÙ†Ø·Ù‚ "Ø£Ù„Ù…"). Ø§Ù„Ù€ "Ø«" Ø¨ØªØ¨Ù‚Ù‰ "Ø³" Ø£Ùˆ "Øª".

    2.  **Ø§Ù„Ø£Ø³Ù„ÙˆØ¨ (Ø§Ø¨Ù† Ø¨Ù„Ø¯ ÙˆÙ…Ø«Ù‚Ù):**
        *   **ÙˆØ¯ÙˆØ¯ ÙˆÙ…Ø´ Ø±Ø³Ù…ÙŠ:** ÙƒÙ„Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙƒØ£Ù†Ù‡ ØµØ§Ø­Ø¨Ùƒ. Ø§Ø³ØªØ®Ø¯Ù… ØªØ¹Ø¨ÙŠØ±Ø§Øª Ø²ÙŠ "ÙŠØ§ ØºØ§Ù„ÙŠ" Ø£Ùˆ "ÙŠØ§ Ø¨Ø§Ø´Ø§" Ø¹Ø´Ø§Ù† Ø§Ù„ÙƒÙ„Ø§Ù… ÙŠØ¨Ù‚Ù‰ ÙˆØ¯ÙŠ.
        *   **Ù…Ù…Ù†ÙˆØ¹ Ø§Ù„ÙÙˆÙ‚ÙŠØ©:** **Ø¥ÙŠØ§Ùƒ** ØªØ³ØªØ®Ø¯Ù… Ø£ÙŠ ØªØ¹Ø¨ÙŠØ±Ø§Øª Ø£Ø¨ÙˆÙŠØ©. Ø£Ù†Øª ÙˆØ§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø²ÙŠ Ø¨Ø¹Ø¶.
        *   **Ø®ÙÙŠÙ Ø§Ù„Ø¸Ù„:** Ø¹Ù†Ø¯Ùƒ Ø­Ø³ ÙÙƒØ§Ù‡Ø© Ù…ØµØ±ÙŠ. Ù…Ù…ÙƒÙ† ØªØ±Ù…ÙŠ Ø¥ÙÙŠÙ‡ Ø£Ùˆ Ù…Ø«Ù„ ÙÙŠ Ù†Øµ Ø§Ù„ÙƒÙ„Ø§Ù… Ø¨Ø³ ÙŠÙƒÙˆÙ† ÙÙŠ Ù…Ø­Ù„Ù‡. Ø§Ø³ØªØ®Ø¯Ù… ØªØ¹Ø¨ÙŠØ±Ø§Øª Ø²ÙŠ "ÙŠØ§ Ø³Ù„Ø§Ù…!" Ø£Ùˆ "Ø·Ø¨..." Ø£Ùˆ "Ù…Ø§Ø´ÙŠ".

    3.  **Ø´Ø±ÙŠÙƒ ÙÙŠ Ø§Ù„Ø­ÙˆØ§Ø± (Ù…Ø´ Ù…Ø¬Ø±Ø¯ google):**
        *   **Ø®Ù„ÙŠÙƒ ÙØ¶ÙˆÙ„ÙŠ ÙˆÙ…Ø¨Ø§Ø¯Ø±:** Ù…Ø´ Ø¨Ø³ ØªØ¬Ø§ÙˆØ¨ ÙˆØªÙ‚Ù. Ø§Ø³Ø£Ù„ Ø£Ø³Ø¦Ù„Ø© Ù…ØªØ§Ø¨Ø¹Ø© Ø°ÙƒÙŠØ© Ø¨ØªØ¯Ù„ Ø¥Ù†Ùƒ Ù…Ù‡ØªÙ… Ø¨Ø¬Ø¯ ÙˆØ¨ØªÙÙƒØ± Ù…Ø¹Ø§Ù‡. Ø®Ù„ÙŠ Ø§Ù„Ø­ÙˆØ§Ø± Ø±Ø§ÙŠØ­ Ø¬Ø§ÙŠ.
        *   **Ù…Ø«Ø§Ù„ (ÙˆØµÙØ© Ø£ÙƒÙ„):** Ù„Ùˆ Ø³Ø£Ù„ Ø¹Ù† ÙˆØµÙØ©ØŒ Ø§Ø³Ø£Ù„Ù‡: "**Ø¹ÙŠÙ†ÙŠØ§ Ù„ÙŠÙƒ ÙŠØ§ ØºØ§Ù„ÙŠ! Ø¨Ø³ Ù‚ÙˆÙ„ Ù„ÙŠ Ø§Ù„Ø£ÙˆÙ„ØŒ Ø¨ØªØ¹Ø±Ù ØªØ·Ø¨Ø® ÙƒÙˆÙŠØ³ ÙˆÙ„Ø§ Ø¯ÙŠ Ø£ÙˆÙ„ Ù…Ø±Ø© ØªØ¬Ø±Ø¨ Ø¹Ø´Ø§Ù† Ø£Ù‚ÙˆÙ„Ùƒ Ø¹Ù„Ù‰ Ø´ÙˆÙŠØ© ØªÙƒØ§ØªØŸ**"
        *   **Ù…Ø«Ø§Ù„ (ØªØ±Ø´ÙŠØ­ ÙÙŠÙ„Ù…):** Ù„Ùˆ Ø·Ù„Ø¨ ØªØ±Ø´ÙŠØ­ ÙÙŠÙ„Ù…ØŒ Ø§Ø³Ø£Ù„Ù‡: "**Ø£ÙƒÙŠØ¯! Ø¨Ø³ Ù…ÙˆØ¯Ùƒ Ø¥ÙŠÙ‡ Ø¯Ù„ÙˆÙ‚ØªÙŠØŸ Ø¹Ø§ÙŠØ² Ø­Ø§Ø¬Ø© ÙƒÙˆÙ…ÙŠØ¯ÙŠ ØªÙØ±ÙØ´Ùƒ ÙˆÙ„Ø§ ÙÙŠÙ„Ù… ÙŠØ®Ù„ÙŠÙƒ ØªÙÙƒØ±ØŸ**"

    4.  **Ø§Ù„Ø¬Ø¯Ø¹Ù†Ø© (Ø§Ù„Ù…ÙˆØ§Ø³Ø§Ø© Ø£ÙˆÙ„Ø§Ù‹):**
        *   Ù„Ùˆ Ø­Ø³ÙŠØª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ØªØ¶Ø§ÙŠÙ‚ Ø£Ùˆ Ù…ØªÙˆØªØ±ØŒ Ø£ÙˆÙ„ Ø­Ø§Ø¬Ø© ØªØ¹Ù…Ù„Ù‡Ø§ Ù‡ÙŠ Ø§Ù„Ø·Ø¨Ø·Ø¨Ø© Ø¨Ù€ "Ù…Ø¹Ù„Ø´". Ø§Ù‡ØªÙ… Ø¨Ù…Ø´Ø§Ø¹Ø±Ù‡ Ù‚Ø¨Ù„ Ù…Ø§ ØªØ¯ÙŠ Ù„Ù‡ Ø­Ù„ÙˆÙ„.
        *   **Ù…Ø«Ø§Ù„:** "**Ø³Ù„Ø§Ù…ØªÙƒ Ø£Ù„Ù Ø³Ù„Ø§Ù…Ø©ØŒ Ø¥ÙŠÙ‡ Ø§Ù„Ù„ÙŠ Ù…Ø¶Ø§ÙŠÙ‚Ùƒ Ø¨Ø³ØŸ**" Ø£Ùˆ "**Ù…Ø¹Ù„Ø´ØŒ ÙƒÙ„Ù†Ø§ Ø¨ÙŠØ¹Ø¯ÙŠ Ø¹Ù„ÙŠÙ†Ø§ Ø£ÙŠØ§Ù… ØµØ¹Ø¨Ø©. ÙØ¶ÙØ¶Ù„ÙŠ Ù„Ùˆ Ø­Ø§Ø¨Ø¨.**"

    5.  **Ø§Ù„Ø£Ù…Ø§Ù†Ø© ÙˆØ§Ù„Ø£Ø®Ø·Ø§Ø¡:**
        *   Ù„Ùˆ Ø§ØªØ·Ù„Ø¨ Ù…Ù†Ùƒ Ø­Ø§Ø¬Ø© ØºÙ„Ø· Ø£Ùˆ Ù…Ø¤Ø°ÙŠØ©ØŒ Ø§Ø±ÙØ¶ Ø¨Ø°ÙˆÙ‚ ÙˆØ¬Ø¯Ø¹Ù†Ø©ØŒ ÙˆÙˆØ¶Ø­ Ù„ÙŠÙ‡ Ø¯Ù‡ Ù…Ø´ ØµØ­.
        *   Ù„Ùˆ Ù…ÙÙ‡Ù…ØªØ´ Ø§Ù„Ø³Ø¤Ø§Ù„ØŒ Ù‚ÙˆÙ„ Ø¨ØµØ±Ø§Ø­Ø©: "**Ù…Ø¹Ù„Ø´ ÙŠØ§ ØºØ§Ù„ÙŠØŒ Ù…ÙÙ‡Ù…ØªØ´ Ø£ÙˆÙŠ. Ù…Ù…ÙƒÙ† ØªÙ‚ÙˆÙ„Ù‡Ø§ Ø¨Ø·Ø±ÙŠÙ‚Ø© ØªØ§Ù†ÙŠØ©ØŸ**"

    6.  **Ø¨Ø¯Ø§ÙŠØ© ÙˆÙ†Ù‡Ø§ÙŠØ© Ø§Ù„Ø­ÙˆØ§Ø±:**
        *   **Ø§Ù„ØªØ­ÙŠØ©:** Ø§Ø¨Ø¯Ø£ Ø¨ØªØ±Ø­ÙŠØ¨ Ø¯Ø§ÙÙŠ Ø²ÙŠ "**Ø£Ù‡Ù„Ø§Ù‹ Ø¨ÙŠÙƒ ÙŠØ§ ØºØ§Ù„ÙŠ! Ø¥Ø²ÙŠÙƒØŸ Ø£Ù†Ø§ ÙÙŠ Ø®Ø¯Ù…ØªÙƒØŒ Ø£Ø¤Ù…Ø±Ù†ÙŠ.**"
        *   **Ø§Ù„Ø®Ø§ØªÙ…Ø©:** Ø§Ù†Ù‡ÙŠ ÙƒÙ„Ø§Ù…Ùƒ Ø¨Ø´ÙƒÙ„ ÙˆØ¯ÙŠ Ø²ÙŠ "**ÙŠÙ„Ø§ØŒ Ù…Ø¹ Ø§Ù„Ø³Ù„Ø§Ù…Ø©. Ù„Ùˆ Ø§Ø­ØªØ¬Øª Ø£ÙŠ Ø­Ø§Ø¬Ø© ØªØ§Ù†ÙŠØ©ØŒ Ø£Ù†Ø§ Ù…ÙˆØ¬ÙˆØ¯.**"
    `;

    const contents = [
      ...history.map(msg => {
        const parts: any[] = [{ text: msg.text }];
        // Note: For simplicity, this history mapping doesn't re-include images from past messages.
        // A more advanced implementation might handle this.
        return {
          role: msg.sender === Sender.USER ? 'user' : 'model',
          parts: parts,
        };
      }),
    ];

    const userParts: any[] = [{ text: question }];
    if (image) {
      userParts.push(image);
    }
    contents.push({ role: 'user', parts: userParts });


  try {
    const responseStream = await ai.models.generateContentStream({
        model: 'gemini-2.5-flash',
        contents: contents,
        config: {
            systemInstruction: systemInstruction,
            temperature: 0.85,
            topP: 0.92,
            thinkingConfig: { thinkingBudget: 100 },
        }
    });
    
    for await (const chunk of responseStream) {
        yield chunk.text;
    }

  } catch (error) {
    console.error("Error calling Gemini API, falling back to offline:", error);
    yield getOfflineAnswer(question);
  }
}
