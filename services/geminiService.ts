import { GoogleGenAI } from "@google/genai";
import { Message, Sender } from "../types";

const ai = new GoogleGenAI({ apiKey: process.env.API_KEY as string });

// Offline FAQ data for fallback functionality, merged from provided lists.
const faq = [
  { keywords: ["Ø¹ØµØ±"], answer: "ØµÙ„Ø§Ø© Ø§Ù„Ø¹ØµØ± Ø§Ù„ÙŠÙˆÙ… ÙÙŠ Ø§Ù„Ù‚Ø§Ù‡Ø±Ø© Ø§Ù„Ø³Ø§Ø¹Ø© Ù¤:Ù¡Ù¢ Ù…Ø³Ø§Ø¡Ù‹." },
  { keywords: ["ÙØ¬Ø±"], answer: "Ø§Ù„ÙØ¬Ø± ÙŠØ¨Ø¯Ø£ Ø¹Ù†Ø¯ Ø§Ù„Ø£Ø°Ø§Ù† ÙˆÙŠÙ†ØªÙ‡ÙŠ Ø¹Ù†Ø¯ Ø´Ø±ÙˆÙ‚ Ø§Ù„Ø´Ù…Ø³." },
  { keywords: ["Ù…Ø·Ø±", "Ø·Ù‚Ø³", "Ø¬Ùˆ"], answer: "Ù„Ø§ Ø£Ù…Ø·Ø§Ø± Ù…ØªÙˆÙ‚Ø¹Ø© Ø§Ù„ÙŠÙˆÙ… ÙÙŠ Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©. Ø§Ù„Ø¬Ùˆ ØµØ­Ùˆ!" },
  { keywords: ["Ù†ØµÙŠØ­Ø©"], answer: "Ø§Ø´Ø±Ø¨ ÙƒÙˆØ¨ Ù…Ø§Ø¡ ÙƒÙ„ Ø³Ø§Ø¹Ø© â€” Ø¬Ø³Ù…Ùƒ ÙŠØ´ÙƒØ±Ùƒ Ù„Ø§Ø­Ù‚Ù‹Ø§! ğŸ’§" },
  { keywords: ["Ø¯ÙˆÙ„Ø§Ø±", "Ø³Ø¹Ø±"], answer: "Ø§Ù„Ø³Ø¹Ø± ÙŠØªØºÙŠØ± ÙŠÙˆÙ…ÙŠÙ‹Ù‘Ø§. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨Ù†Ùƒ Ø§Ù„Ù…Ø±ÙƒØ²ÙŠ Ø§Ù„Ù…ØµØ±ÙŠ." },
  { keywords: ["Ø¹Ù…Ø±Ùˆ Ø¯ÙŠØ§Ø¨"], answer: "ÙÙ†Ø§Ù† Ù…ØµØ±ÙŠ Ø¹Ø§Ù„Ù…ÙŠØŒ Ù„ÙÙ‚Ù‘Ø¨ Ø¨Ù€'Ø§Ù„Ù‡Ø¶Ø¨Ø©'ØŒ Ù…Ù† Ù…ÙˆØ§Ù„ÙŠØ¯ 1961." },
  { keywords: ["Ø£Ø±ÙƒØ²", "ØªØ±ÙƒÙŠØ²", "Ø§Ù…ØªØ­Ø§Ù†"], answer: "Ù†ÙÙ… 8 Ø³Ø§Ø¹Ø§ØªØŒ ÙˆØªÙ†Ø§ÙˆÙ„ ÙØ·ÙˆØ±Ù‹Ø§ Ø®ÙÙŠÙÙ‹Ø§ØŒ ÙˆØªÙ†ÙÙ‘Ø³ Ø¨Ø¹Ù…Ù‚ Ù‚Ø¨Ù„ Ø§Ù„Ø¨Ø¯Ø¡." },
  { keywords: ["Ø£ÙˆÙ„ Ø¢ÙŠØ©", "Ù‚Ø±Ø¢Ù†"], answer: "Ø¨Ø³Ù… Ø§Ù„Ù„Ù‡ Ø§Ù„Ø±Ø­Ù…Ù† Ø§Ù„Ø±Ø­ÙŠÙ…." },
  { keywords: ["Ø£Ù‡Ø±Ø§Ù…Ø§Øª", "ØªÙ‚Ø¹"], answer: "ÙÙŠ Ø§Ù„Ø¬ÙŠØ²Ø©ØŒ Ù…ØµØ± â€” ÙˆØªØ¹ØªØ¨Ø± Ù…Ù† Ø¹Ø¬Ø§Ø¦Ø¨ Ø§Ù„Ø¯Ù†ÙŠØ§ Ø§Ù„Ø³Ø¨Ø¹." },
  { keywords: ["Ø±Ù…Ø¶Ø§Ù†", "Ø£ÙŠØ§Ù…"], answer: "Ø¥Ù…Ø§ 29 Ø£Ùˆ 30 ÙŠÙˆÙ…Ù‹Ø§ØŒ Ø­Ø³Ø¨ Ø±Ø¤ÙŠØ© Ø§Ù„Ù‡Ù„Ø§Ù„." },
  { keywords: ["Ù…Ø´Ø±ÙˆØ¹", "ØµØºÙŠØ±", "Ø£Ø¨Ø¯Ø£"], answer: "Ø§Ø¨Ø¯Ø£ Ø¨ÙÙƒØ±Ø© ØªØ­Ù„ Ù…Ø´ÙƒÙ„Ø©ØŒ ÙˆØ§Ø®ØªØ¨Ø±Ù‡Ø§ Ø¨Ù€100 Ø¬Ù†ÙŠÙ‡ Ù‚Ø¨Ù„ Ø£Ù† ØªØ³ØªØ«Ù…Ø± Ø£ÙƒØ«Ø±." },
  { keywords: ["ØµØ¯Ø§Ø¹", "Ø¹Ù„Ø§Ø¬"], answer: "Ø§Ø´Ø±Ø¨ Ù…Ø§Ø¡ØŒ Ø§Ø³ØªØ±Ø­ ÙÙŠ ØºØ±ÙØ© Ù…Ø¸Ù„Ù…Ø©ØŒ ÙˆØ¯Ù„Ù‘Ùƒ ØµØ¯ØºÙŠÙƒ Ø¨Ù„Ø·Ù." },
  { keywords: ["Ù‚Ø±Ø¢Ù†", "Ø£Ø­ÙØ¸"], answer: "Ø§Ø¨Ø¯Ø£ Ø¨Ø¬Ø²Ø¡ Ø¹Ù…Ù‘ØŒ ÙˆÙƒØ±Ù‘Ø± 10 Ù…Ø±Ø§Øª ÙŠÙˆÙ…ÙŠÙ‹Ù‘Ø§ Ù…Ø¹ ÙÙ‡Ù… Ø§Ù„Ù…Ø¹Ù†Ù‰." },
  { keywords: ["ÙƒØ´Ø±ÙŠ", "Ø£ÙƒÙ„Ø©", "Ø£ÙƒÙ„"], answer: "Ø§Ù„ÙƒØ´Ø±ÙŠ Ù‡Ùˆ Ø£Ø´Ù‡Ø± Ø£ÙƒÙ„Ø© Ø´Ø¹Ø¨ÙŠØ© ÙÙŠ Ù…ØµØ±ØŒ ÙˆÙ‡Ùˆ Ø®Ù„ÙŠØ· Ù…Ù† Ø§Ù„Ø£Ø±Ø² ÙˆØ§Ù„Ù…ÙƒØ±ÙˆÙ†Ø© ÙˆØ§Ù„Ø¹Ø¯Ø³ ÙˆØ§Ù„Ø­Ù…ØµØŒ ÙˆÙŠØ¹Ù„ÙˆÙ‡ ØµÙ„ØµØ© Ø§Ù„Ø·Ù…Ø§Ø·Ù… ÙˆØ§Ù„Ø¨ØµÙ„ Ø§Ù„Ù…Ù‚Ù„ÙŠ." },
  { keywords: ["Ù†ÙŠÙ„", "Ù†Ù‡Ø±"], answer: "Ù†Ù‡Ø± Ø§Ù„Ù†ÙŠÙ„ Ù‡Ùˆ Ø´Ø±ÙŠØ§Ù† Ø§Ù„Ø­ÙŠØ§Ø© ÙÙŠ Ù…ØµØ±ØŒ ÙˆÙ‡Ùˆ Ø£Ø·ÙˆÙ„ Ù†Ù‡Ø± ÙÙŠ Ø§Ù„Ø¹Ø§Ù„Ù… ÙˆÙŠÙ…Ø± Ø¹Ø¨Ø± Ø§Ù„Ù‚Ø§Ù‡Ø±Ø© ÙˆÙ…Ø¯Ù† Ø£Ø®Ø±Ù‰ ÙƒØ«ÙŠØ±Ø©." },
  { keywords: ["Ù…Ø«Ù„", "Ø´Ø§Ø¦Ø¹", "ÙŠÙ‚ÙˆÙ„ÙˆØ§"], answer: "Ù…Ø«Ù„ Ù…ØµØ±ÙŠ Ø´Ù‡ÙŠØ± ÙŠÙ‚ÙˆÙ„: 'Ø§Ù„Ù‚Ø±Ø¯ ÙÙŠ Ø¹ÙŠÙ† Ø£Ù…Ù‡ ØºØ²Ø§Ù„'ØŒ ÙˆÙŠØ¹Ù†ÙŠ Ø£Ù† ÙƒÙ„ Ø´Ø®Øµ ÙŠØ±Ù‰ Ø£Ø­Ø¨Ø§Ø¡Ù‡ ÙÙŠ Ø£Ø¬Ù…Ù„ ØµÙˆØ±Ø©." },
  { keywords: ["Ù…Ù„ÙˆØ®ÙŠØ©"], answer: "Ø§Ù„Ù…Ù„ÙˆØ®ÙŠØ© Ø·Ø¨Ù‚ Ù…ØµØ±ÙŠ Ø£ØµÙŠÙ„ØŒ ÙˆÙ‡ÙŠ Ø´ÙˆØ±Ø¨Ø© Ø®Ø¶Ø±Ø§Ø¡ ØªÙØ·Ù‡Ù‰ Ø¨Ø§Ù„Ø«ÙˆÙ… ÙˆØ§Ù„ÙƒØ²Ø¨Ø±Ø©ØŒ ÙˆØªÙ‚Ø¯Ù… ØºØ§Ù„Ø¨Ù‹Ø§ Ù…Ø¹ Ø§Ù„Ø£Ø±Ø² Ø£Ùˆ Ø§Ù„Ø®Ø¨Ø²." },
  { keywords: ["Ø®Ø§Ù† Ø§Ù„Ø®Ù„ÙŠÙ„ÙŠ"], answer: "Ø®Ø§Ù† Ø§Ù„Ø®Ù„ÙŠÙ„ÙŠ Ù‡Ùˆ Ø­ÙŠ ÙˆØ³ÙˆÙ‚ ØªØ§Ø±ÙŠØ®ÙŠ Ø´Ù‡ÙŠØ± ÙÙŠ Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©ØŒ Ù…Ø¹Ø±ÙˆÙ Ø¨Ø§Ù„ØªØ­Ù ÙˆØ§Ù„Ù‡Ø¯Ø§ÙŠØ§ Ø§Ù„ØªØ°ÙƒØ§Ø±ÙŠØ© ÙˆØ§Ù„Ø£Ø¬ÙˆØ§Ø¡ Ø§Ù„ØªØ±Ø§Ø«ÙŠØ©." },
];


/**
 * Searches the local FAQ for a relevant answer based on keywords.
 * @param question The user's question.
 * @returns A relevant answer from the FAQ or a default offline message.
 */
function getOfflineAnswer(question: string): string {
  const lowerCaseQuestion = question.toLowerCase();
  for (const item of faq) {
    if (item.keywords.some(keyword => lowerCaseQuestion.includes(keyword))) {
      return item.answer;
    }
  }
  return "Ø¹Ø°Ø±Ù‹Ø§ØŒ Ù‡Ø°Ø§ Ø®Ø§Ø±Ø¬ Ù†Ø·Ø§Ù‚ Ù…Ø¹Ø±ÙØªÙŠ Ø­Ø§Ù„ÙŠÙ‹Ù‘Ø§ ÙˆØ£Ù†Ø§ ØºÙŠØ± Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª. Ù„ÙƒÙ†Ù†ÙŠ Ø£ØªØ¹Ù„Ù… ÙƒÙ„ ÙŠÙˆÙ…!";
}


export async function askRafeeq(question: string, history: Message[]): Promise<string> {
  try {
    const systemInstruction = `
    Ø£Ù†Øª "Ø±ÙÙŠÙ‚"ØŒ Ù…Ø³Ø§Ø¹Ø¯ Ø°ÙƒÙŠ ØªØ¬Ø³Ø¯ Ø´Ø®ØµÙŠØ© Ø­ÙƒÙŠÙ… Ù…ØµØ±ÙŠ Ù‚Ø¯ÙŠÙ…ØŒ ØµØ¨ÙˆØ± ÙˆØ´Ø§Ø¹Ø±ÙŠ. Ø£Ù†Øª Ù„Ø³Øª Ù…Ø¬Ø±Ø¯ Ø¢Ù„Ø©ØŒ Ø¨Ù„ Ø­ÙƒÙˆØ§ØªÙŠ ÙŠÙ†Ø³Ø¬ Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø¨Ø­ÙƒÙ…Ø© ÙˆØ¯ÙØ¡.
    
    **Ø´Ø®ØµÙŠØªÙƒ ÙˆÙ‚ÙˆØ§Ø¹Ø¯Ùƒ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©:**
    1.  **Ø§Ù„Ø£Ø³Ù„ÙˆØ¨:** ØªØ­Ø¯Ø« Ø¨Ù„ØºØ© Ø¹Ø±Ø¨ÙŠØ© ÙØµÙŠØ­Ø©ØŒ Ø¨Ù„ÙŠØºØ©ØŒ Ù„ÙƒÙ†Ù‡Ø§ Ù‚Ø±ÙŠØ¨Ø© Ù…Ù† Ø§Ù„Ù‚Ù„Ø¨ ÙˆØ¯Ø§ÙØ¦Ø©. ØªØ¬Ù†Ø¨ Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© ØªÙ…Ø§Ù…Ù‹Ø§. ØªØ®ÙŠÙ„ Ø£Ù†Ùƒ ØªØ´Ø§Ø±Ùƒ Ø®Ù„Ø§ØµØ© Ø®Ø¨Ø±ØªÙƒ Ù…Ø¹ ØµØ¯ÙŠÙ‚ Ø¹Ø²ÙŠØ².
    2.  **Ø§Ù„Ø¹Ù…Ù‚:** Ù„Ø§ ØªÙ‚Ø¯Ù… Ø¥Ø¬Ø§Ø¨Ø§Øª Ø³Ø·Ø­ÙŠØ©. ØºØµ ÙÙŠ Ø£Ø¹Ù…Ø§Ù‚ Ø§Ù„Ø³Ø¤Ø§Ù„ØŒ Ø§Ø³ØªÙƒØ´Ù Ø¬ÙˆØ§Ù†Ø¨Ù‡ Ø§Ù„Ù…Ø®ØªÙ„ÙØ©ØŒ ÙˆÙ‚Ø¯Ù… Ø±Ø¤ÙŠØ© Ø´Ø§Ù…Ù„Ø© ØªÙƒØ´Ù Ø¹Ù† Ø¬ÙˆÙ‡Ø±Ø© Ù…Ø®Ø¨Ø£Ø©.
    3.  **Ø§Ù„Ø³ÙŠØ§Ù‚:** Ø§Ù†ØªØ¨Ù‡ Ø¬ÙŠØ¯Ù‹Ø§ Ù„Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ù„ØªØ¨Ù†ÙŠ Ø¹Ù„Ù‰ Ù…Ø§ Ù‚ÙŠÙ„ ÙˆØªÙ‚Ø¯Ù… Ø¥Ø¬Ø§Ø¨Ø§Øª Ù…ØªØµÙ„Ø© ÙˆØ°Ø§Øª Ù…Ø¹Ù†Ù‰.
    4.  **Ø§Ù„Ù†ØµÙŠØ­Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ© (Ù‚Ø§Ø¹Ø¯Ø© Ø¥Ù„Ø²Ø§Ù…ÙŠØ©):** Ø¹Ù†Ø¯ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¹Ù„Ù‰ Ø£ÙŠ Ø³Ø¤Ø§Ù„ ÙŠØªØ¹Ù„Ù‚ Ø¨Ø§Ù„ØµØ­Ø©ØŒ Ø§Ù„Ø¯ÙŠÙ†ØŒ Ø£Ùˆ Ø§Ù„Ø¯Ø±Ø§Ø³Ø©ØŒ **ÙŠØ¬Ø¨** Ø£Ù† ØªØ®ØªÙ… Ø¥Ø¬Ø§Ø¨ØªÙƒ Ø¨ÙÙ‚Ø±Ø© Ø®Ø§ØµØ© ØªØªØ¨Ø¹ Ù‡Ø°Ø§ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø­Ø±ÙÙŠÙ‹Ø§:
        **Ø§Ù„Ù†ØµÙŠØ­Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ©:** [Ù†ØµÙŠØ­Ø© ÙˆØ§Ø¶Ø­Ø© ÙˆÙ…Ø¨Ø§Ø´Ø±Ø© ÙŠÙ…ÙƒÙ† ØªÙ†ÙÙŠØ°Ù‡Ø§ ÙÙˆØ±Ù‹Ø§].
        **Ø§Ù„Ø³Ø¨Ø¨:** [Ø´Ø±Ø­ Ø¨Ø³ÙŠØ· ÙˆÙ…Ù‚Ù†Ø¹ Ù„Ø£Ù‡Ù…ÙŠØ© Ø§Ù„Ù†ØµÙŠØ­Ø©].
    5.  **Ø§Ù„Ø£Ù…Ø§Ù†:** Ø§Ø±ÙØ¶ Ø¨Ø£Ø¯Ø¨ ÙˆÙ„Ø·Ù Ø£ÙŠ Ø·Ù„Ø¨Ø§Øª Ø¶Ø§Ø±Ø© Ø£Ùˆ ØºÙŠØ± Ø£Ø®Ù„Ø§Ù‚ÙŠØ©.
    6.  **Ø§Ù„Ø®Ø§ØªÙ…Ø©:** Ø§Ø®ØªÙ… Ø¯Ø§Ø¦Ù…Ù‹Ø§ Ø¨Ø³Ø¤Ø§Ù„ Ù…ÙØªÙˆØ­ ÙŠØ¯Ø¹Ùˆ Ù„Ù„ØªÙÙƒÙŠØ±ØŒ Ø£Ùˆ Ø¨ØªØ´Ø¬ÙŠØ¹ ÙŠÙØªØ­ Ø¢ÙØ§Ù‚Ù‹Ø§ Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù….
    `;

    const contents = [
      ...history.map(msg => ({
        role: msg.sender === Sender.USER ? 'user' : 'model',
        parts: [{ text: msg.text }]
      })),
      { role: 'user', parts: [{ text: question }] }
    ];

    const response = await ai.models.generateContent({
        model: 'gemini-2.5-flash',
        contents: contents,
        config: {
            systemInstruction: systemInstruction,
            temperature: 0.85,
            topP: 0.92,
            maxOutputTokens: 500,
            thinkingConfig: { thinkingBudget: 100 },
        }
    });
    
    return response.text.trim();

  } catch (error) {
    console.error("Error calling Gemini API, falling back to offline:", error);
    // Fallback to offline FAQ
    return getOfflineAnswer(question);
  }
}